{"componentChunkName":"component---src-templates-blog-template-js","path":"/blog/2019/03/04/react-fiber.html","result":{"data":{"markdownRemark":{"html":"<p><a href=\"https://indepth.dev/the-how-and-why-on-reacts-usage-of-linked-list-in-fiber-to-walk-the-components-tree\">åŸæ–‡é“¾æ¥</a></p>\n<h2>å‰ç½®çŸ¥è¯†</h2>\n<p>Fiber æ¶æ„æœ‰ä¸¤ä¸ªä¸»è¦çš„æ¸²æŸ“é˜¶æ®µ:</p>\n<ul>\n<li>reconciliation/render</li>\n<li>commit</li>\n</ul>\n<p>åœ¨æºç ä¸­ reconciliation é˜¶æ®µä¹Ÿè¢«è§†ä¸º \"render\" é˜¶æ®µ. åœ¨è¯¥é˜¶æ®µ, React ä¼šéå†æ•´ä¸ªç»„ä»¶æ ‘, å¹¶ä¸”è¿›è¡Œå¦‚ä¸‹æ“ä½œ:</p>\n<ul>\n<li>æ›´æ–° state å’Œ props</li>\n<li>è°ƒç”¨ç”Ÿå‘½å‘¨æœŸæ–¹æ³•</li>\n<li>æ£€ç´¢å½“å‰ç»„ä»¶çš„å­ç»„ä»¶</li>\n<li>æ¯”å¯¹æ–°è€å­ç»„ä»¶</li>\n<li>è®¡ç®—å‡ºéœ€è¦åœ¨ commit é˜¶æ®µè¢«æ‰§è¡Œçš„ DOM æ›´æ–°</li>\n</ul>\n<p>ä¸Šè¿°æ‰€æœ‰æ“ä½œè¢«ç§°ä¸º <strong>Fiber å†…éƒ¨å·¥ä½œ(work inside Fiber)</strong>ã€‚ éœ€è¦å®Œæˆçš„å·¥ä½œç±»å‹å–å†³äº <code class=\"language-text\">React Element</code> çš„ç±»å‹. æ¯”å¦‚, å¯¹äº <code class=\"language-text\">Class Component</code>, React ä¼šè¿›è¡Œå®ä¾‹åŒ–, ç„¶è€Œä¸ä¼šå®ä¾‹åŒ– <code class=\"language-text\">Functional Component</code>ã€‚ å¦‚æœæ„Ÿå…´è¶£çš„è¯, <a href=\"https://github.com/facebook/react/blob/340bfd9393e8173adca5380e6587e1ea1a23cefa/packages/shared/ReactWorkTags.js?source=post_page---------------------------#L29-L28\">åœ¨è¿™é‡Œ</a> ä½ å¯ä»¥çœ‹åˆ° <code class=\"language-text\">Fiber</code> ä¸Šæ‰€æœ‰çš„å·¥ä½œç±»å‹ã€‚ Andrew ä¹Ÿåœ¨æ¼”è®²ä¸­æåˆ°äº†è¿™äº›:</p>\n<blockquote>\n<p>å½“å¤„ç† <code class=\"language-text\">UI</code> çš„æ—¶å€™, å¦‚æœä¸€æ¬¡æ€§æ‰§è¡Œå¤ªå¤šçš„ <code class=\"language-text\">React</code> å·¥ä½œ, é‚£ä¹ˆå¯èƒ½ä¼šå¯¼è‡´åŠ¨ç”»æ‰å¸§...</p>\n</blockquote>\n<p>é‚£ä¹ˆ 'ä¸€æ¬¡æ€§æ‰§è¡Œ' æŒ‡çš„æ˜¯ä»€ä¹ˆ? å¦‚æœ React ä»¥<strong>åŒæ­¥çš„æ–¹å¼</strong>éå†æ•´ä¸ªç»„ä»¶æ ‘, å¹¶ä¸”å¯¹æ¯ä¸ªç»„ä»¶è¿›è¡Œæ›´æ–°, é‚£ä¹ˆä»£ç çš„æ‰§è¡Œæ—¶é—´æœ‰å¯èƒ½ä¼šè¶…è¿‡ <code class=\"language-text\">16ms</code> æœ‰æ•ˆæ—¶é—´, ä»è€Œé€ æˆæ‰å¸§å¡é¡¿ç°è±¡ã€‚</p>\n<p>é‚£ä¹ˆè¿™ä¸ªé—®é¢˜å¯ä»¥è§£å†³å—?</p>\n<blockquote>\n<p>è¾ƒæ–°çš„æµè§ˆå™¨ä»¥åŠ React Native å®ç°äº†ç›¸å…³ API, æ¥è§£å†³è¿™ä¸ªé—®é¢˜...</p>\n</blockquote>\n<p>å…¨å±€å‡½æ•°â€”â€” <a href=\"https://developers.google.com/web/updates/2015/08/using-requestidlecallback\">requestIdleCallback</a>, å¯ä»¥æŠŠå‡½æ•°åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­, ç­‰åˆ°æµè§ˆå™¨ç©ºé—²çš„æ—¶å€™å†å»è°ƒç”¨ï¼Œç„¶è€Œæˆ‘ä»¬æœ€å¥½åœ¨è¿™ä¸ªæ—¶é—´èŒƒå›´å†…æ‰§è¡Œå®Œæ¯•ï¼Œç„¶åäº¤è¿˜æ§åˆ¶æƒç»™æµè§ˆå™¨,ä¸ç„¶ä¼šä¾ç„¶ä¼šå¯¼è‡´UIé˜»å¡,æˆ‘ä»¬å¯ä»¥çœ‹ä¸‹æµè§ˆå™¨æ¯ä¸€å¸§éƒ½æ‰§è¡Œäº†ä»€ä¹ˆä»»åŠ¡(Task), èŠ±è´¹äº†å¤šå°‘æ—¶é—´ã€‚</p>\n<p><img src=\"https://p6.music.126.net/obj/wo3DlcOGw6DClTvDisK1/8078327500/0765/0701/0d25/29978cb29a7d1e3d1b17554762f9765b.png\" alt=\"\"></p>\n<p>æµè§ˆå™¨åœ¨ä¸€å¸§å†…å¯èƒ½ä¼šåšæ‰§è¡Œä¸‹åˆ—ä»»åŠ¡ï¼Œè€Œä¸”å®ƒä»¬çš„æ‰§è¡Œé¡ºåºåŸºæœ¬æ˜¯å›ºå®šçš„:</p>\n<ul>\n<li>å¤„ç†ç”¨æˆ·è¾“å…¥äº‹ä»¶</li>\n<li>Javascriptæ‰§è¡Œ</li>\n<li>requestAnimation è°ƒç”¨</li>\n<li>å¸ƒå±€ Layout</li>\n<li>ç»˜åˆ¶ Paint</li>\n</ul>\n<p>ä¸Šé¢è¯´ç†æƒ³çš„ä¸€å¸§æ—¶é—´æ˜¯ 16ms (1000ms / 60)ï¼Œå¦‚æœæµè§ˆå™¨å¤„ç†å®Œä¸Šè¿°çš„ä»»åŠ¡(å¸ƒå±€å’Œç»˜åˆ¶ä¹‹å)ï¼Œè¿˜æœ‰ç›ˆä½™æ—¶é—´ï¼Œæµè§ˆå™¨å°±ä¼šè°ƒç”¨ requestIdleCallback çš„å›è°ƒã€‚ä¾‹å¦‚:</p>\n<p><img src=\"https://p5.music.126.net/obj/wo3DlcOGw6DClTvDisK1/8078337702/b5ea/0f2a/4114/a6e95292a28c2b0d100da1a4bf1be6a6.png\" alt=\"\"></p>\n<p>ä¸‹é¢çš„ä¾‹å­å‘Šè¯‰ä½ å¦‚ä½•ä½¿ç”¨å®ƒ:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">requestIdleCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">deadline</span><span class=\"token punctuation\">)</span><span class=\"token operator\">=></span><span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>deadline<span class=\"token punctuation\">.</span><span class=\"token function\">timeRemaining</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> deadline<span class=\"token punctuation\">.</span>didTimeout<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>å¦‚æœåœ¨ <code class=\"language-text\">console</code> æ§åˆ¶å°æ‰§è¡Œä¸Šè¿°ä»£ç , Chrome æµè§ˆå™¨ä¼šæ‰“å° <code class=\"language-text\">49.9, false</code>. è¿™è¡¨æ˜æˆ‘æœ‰ <code class=\"language-text\">49.9ms</code> å»åšä»»ä½•æˆ‘æƒ³åšçš„å·¥ä½œ, å¹¶ä¸”æ—¶é—´è¿˜æœ‰å¯Œä½™, å¦åˆ™ <code class=\"language-text\">deadline.didTimeout</code> ä¼šå˜ä¸º <code class=\"language-text\">true</code>. è®°ä½, ä¸€æ—¦æµè§ˆå™¨æ‰§è¡Œå·¥ä½œ, <code class=\"language-text\">timeRemaining</code> ä¼šç«‹åˆ»æ”¹å˜, æ‰€ä»¥åº”è¯¥éšæ—¶æ£€æŸ¥å®ƒã€‚</p>\n<blockquote>\n<p>requestIdleCallback åœ¨ä½¿ç”¨ä¸Šå…¶å®æ˜¯æœ‰å±€é™æ€§çš„, ä¸èƒ½é¢‘ç¹åœ°è°ƒç”¨å®ƒå»å®ç°å¹³æ»‘çš„ UI æ¸²æŸ“(å½“æµè§ˆå™¨å¼‚å¸¸ç¹å¿™çš„æ—¶å€™ï¼Œå¯èƒ½ä¸ä¼šæœ‰ç›ˆä½™æ—¶é—´ï¼Œè¿™æ—¶å€™requestIdleCallbackå›è°ƒå¯èƒ½å°±ä¸ä¼šè¢«æ‰§è¡Œ),å¦å¤–ç”±äºåªæœ‰è¾ƒæ–°çš„æµè§ˆå™¨å®ç°äº†è¯¥API, æ‰€ä»¥ React å›¢é˜Ÿ ä¸å¾—ä¸å®ç°ä»–ä»¬è‡ªå·±çš„ç‰ˆæœ¬ã€‚</p>\n</blockquote>\n<p>å‡å¦‚æˆ‘ä»¬å°† React æ›´æ–°ç»„ä»¶çš„ä»£ç æ”¾åˆ° <code class=\"language-text\">performWork</code> å‡½æ•°, ä½¿ç”¨ <code class=\"language-text\">requestIdleCallback</code> å»è°ƒåº¦, ä»£ç ä¼šå˜æˆä¸‹é¢è¿™æ ·:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">requestIdleCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">deadline</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// while we have time, perform work for a part of the components tree</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>deadline<span class=\"token punctuation\">.</span><span class=\"token function\">timeRemaining</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> deadline<span class=\"token punctuation\">.</span>didTimeout<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> nextComponent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        nextComponent <span class=\"token operator\">=</span> <span class=\"token function\">performWork</span><span class=\"token punctuation\">(</span>nextComponent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>ä¸Šè¿°ä»£ç å¯¹äºå•ä¸ªç»„ä»¶æ‰§è¡Œç›¸å…³æ›´æ–°å·¥ä½œ, å¹¶ä¸”è¿”å›äº†æŒ‡å‘ä¸‹ä¸€ä¸ªç»„ä»¶çš„å¼•ç”¨. ä¸ç”¨å†åƒä¹‹å‰çš„ <a href=\"https://reactjs.org/docs/codebase-overview.html#stack-reconciler\">reconciliation</a> ç®—æ³•é‚£æ ·, åŒæ­¥å¤„ç†ç»„ä»¶æ ‘. Andrew ä¹Ÿè°ˆåˆ°äº†è¿™ä¸ªé—®é¢˜:</p>\n<blockquote>\n<p>ä¸ºäº†ä½¿ç”¨è¿™äº› API, ä½ éœ€è¦ä¸€ç§å¯ä»¥å°†æ¸²æŸ“å·¥ä½œæ‹†åˆ†ä¸ºå•å…ƒ</p>\n</blockquote>\n<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜, React é‡æ–°å®ç°äº†æ ‘çš„éå†ç®—æ³•, <strong>åŸæœ¬çš„ç®—æ³•é‡‡ç”¨åŸºäºå†…ç½®å †æ ˆçš„åŒæ­¥é€’å½’ç­–ç•¥, è€Œæ–°çš„ç®—æ³•åˆ™æ˜¯åŸºäºé“¾è¡¨å’ŒæŒ‡é’ˆçš„å¼‚æ­¥ç­–ç•¥</strong>ã€‚ Andrew çš„æ–‡ç« ä¹Ÿæåˆ°äº†:</p>\n<blockquote>\n<p>å¦‚æœåªä¾èµ–å†…ç½®çš„è°ƒç”¨æ ˆ, é‚£ä¹ˆ React ä¼šä¸€ç›´å·¥ä½œç›´åˆ°è°ƒç”¨æ ˆä¸ºç©º...ï¼Œ å¦‚æœå¯ä»¥ä¸­æ–­è°ƒç”¨æ ˆå¹¶ä¸”æ‰‹åŠ¨æ“ä½œè°ƒç”¨æ ˆçš„æ¯ä¸€å¸§, é‚£ä¸æ˜¯ç¾æ»‹æ»‹ä¹ˆ? è¿™å…¶å®å°±æ˜¯ React Fiber çš„æ€æƒ³. <strong>Fiber ä¸“ä¸º React ç»„ä»¶è®¾è®¡, å®ƒé‡æ–°å®ç°äº†è°ƒç”¨æ ˆ</strong>ã€‚ ä½ ä¹Ÿå¯ä»¥æŠŠæ¯ä¸ª Fiber å½“ä½œä¸€ä¸ªå¸§ã€‚</p>\n</blockquote>\n<h2>ä»€ä¹ˆæ˜¯å †æ ˆ?</h2>\n<p>æˆ‘å‡è®¾ä½ å·²ç»ç†Ÿæ‚‰äº†è°ƒç”¨æ ˆçš„ç›¸å…³æ¦‚å¿µ. ç»™ä»£ç æ‰“ä¸ªæ–­ç‚¹, ç„¶ååœ¨æµè§ˆå™¨è°ƒè¯•çª—å£å°±å¯ä»¥çœ‹åˆ°å®ƒçš„è°ƒç”¨æ ˆ. ä¸‹é¢æ˜¯ ç»´åŸºç™¾ç§‘ å¯¹å®ƒçš„è§£é‡Š:</p>\n<blockquote>\n<p>In computer science, a <em>call stack</em> is a stack data structure that stores information about the active subroutines of a computer programâ€¦ the main reason for having call stack is <em>to keep track of the point</em> to which each active subroutine should return control when it finishes executingâ€¦ A <em>call stack</em> is composed of <em>stack frames</em>â€¦ Each stack frame corresponds to a call to a subroutine which has not yet terminated with a <em>return</em>. For example, if a subroutine named DrawLine is currently running, having been called by a subroutine DrawSquare, the top part of the call stack might be laid out like in the adjacent picture.</p>\n</blockquote>\n<p><img src=\"https://p5.music.126.net/obj/wo3DlcOGw6DClTvDisK1/8052460125/9d33/235b/893d/05c8ee9e54032622515a04108cc07220.png\" alt=\"\"></p>\n<h3>ä¸ºä»€ä¹ˆæ ˆå’Œ React æœ‰å…³?</h3>\n<p>æˆ‘åœ¨æ–‡ç« çš„ç¬¬ä¸€éƒ¨åˆ†æåˆ°äº†, React åœ¨ reconciliation/render é˜¶æ®µéå†ç»„ä»¶æ ‘å¹¶æ›´æ–°ç»„ä»¶. ä¹‹å‰çš„ç®—æ³•é‡‡ç”¨çš„æ˜¯åŸºäºå†…ç½®è°ƒç”¨æ ˆè¿›è¡ŒåŒæ­¥é€’å½’éå†ç»„ä»¶æ ‘çš„ç­–ç•¥. è¿™ç¯‡æ–‡ç«  ä»‹ç»äº† <a href=\"https://reactjs.org/docs/reconciliation.html?source=post_page---------------------------#recursing-on-children\">reconciliation</a> é€’å½’ç®—æ³•:</p>\n<p>åœ¨æ–‡ç« çš„ç¬¬ä¸€éƒ¨åˆ†æˆ‘ä»¬æåˆ°, React åœ¨ reconciliation/render é˜¶æ®µéå†ç»„ä»¶æ ‘å¹¶æ›´æ–°ç»„ä»¶. ä¹‹å‰çš„ reconciler ç®—æ³•é‡‡ç”¨çš„æ˜¯åŒæ­¥é€’å½’å†…ç½®è°ƒç”¨æ ˆçš„ç­–ç•¥. å®˜æ–¹æ–‡æ¡£ é˜è¿°äº†è¿™ä¸ªè¿‡ç¨‹å¹¶ä¸”è§£é‡Šäº†é€’å½’ç®—æ³•ã€‚</p>\n<p>é»˜è®¤æƒ…å†µä¸‹, å½“é€’å½’éå†æŸä¸ª DOM èŠ‚ç‚¹çš„å­èŠ‚ç‚¹æ—¶, React åªåŒæ—¶éå†ä¸¤ä¸ªå­èŠ‚ç‚¹åˆ—è¡¨, åœ¨éå†è¿‡ç¨‹ä¸­æ‰¾åˆ°å®ƒä»¬çš„å·®å¼‚å¹¶ç”Ÿæˆä¸€ä¸ª mutation(çªå˜)ã€‚</p>\n<p>ä½ æƒ³æƒ³, æ¯æ¬¡é€’å½’éƒ½ä¼šåœ¨æ ˆä¸­æ·»åŠ ä¸€ä¸ªå¸§. å¹¶ä¸”å®ƒæ˜¯åŒæ­¥çš„. å‡è®¾æœ‰å¦‚ä¸‹çš„ç»„ä»¶æ ‘:</p>\n<p><img src=\"https://p5.music.126.net/obj/wo3DlcOGw6DClTvDisK1/8052507630/540d/c408/5847/fd7b72a284a043b53052256c4446c4c5.png\" alt=\"\"></p>\n<p>å¦‚ä¸‹æ‰€ç¤ºçš„ render å‡½æ•°ä¼šè¿”å›ä¸€äº›å¯¹è±¡. ä½ å¯ä»¥æŠŠè¿™äº›å¯¹è±¡çœ‹ä½œ React ç»„ä»¶çš„å®ä¾‹:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> a1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>name<span class=\"token operator\">:</span> <span class=\"token string\">'a1'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> b1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>name<span class=\"token operator\">:</span> <span class=\"token string\">'b1'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> b2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>name<span class=\"token operator\">:</span> <span class=\"token string\">'b2'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> b3 <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>name<span class=\"token operator\">:</span> <span class=\"token string\">'b3'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> c1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>name<span class=\"token operator\">:</span> <span class=\"token string\">'c1'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> c2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>name<span class=\"token operator\">:</span> <span class=\"token string\">'c2'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> d1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>name<span class=\"token operator\">:</span> <span class=\"token string\">'d1'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> d2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>name<span class=\"token operator\">:</span> <span class=\"token string\">'d2'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\na1<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">render</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>b1<span class=\"token punctuation\">,</span> b2<span class=\"token punctuation\">,</span> b3<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\nb1<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">render</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\nb2<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">render</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>c1<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\nb3<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">render</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>c2<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\nc1<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">render</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">[</span>d1<span class=\"token punctuation\">,</span> d2<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\nc2<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">render</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\nd1<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">render</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\nd2<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">render</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>React éœ€è¦éå†æ•´ä¸ªç»„ä»¶æ ‘å¹¶å¯¹æ¯ä¸€ä¸ªç»„ä»¶è¿›è¡Œæ›´æ–°æ“ä½œ. ä¸ºäº†ç®€åŒ–è¿™ä¸ªè¿‡ç¨‹, åœ¨æ›´æ–°æ¯ä¸ªç»„ä»¶çš„æ—¶å€™, åªä¼šæ‰“å°å½“å‰ç»„ä»¶çš„ name å±æ€§çš„å€¼ä»¥åŠè¿”å›å®ƒçš„å­ç»„ä»¶. ä¸‹é¢æ˜¯é€’å½’çš„å®ç°æ–¹å¼ã€‚</p>\n<h3>é€’å½’éå†</h3>\n<p>é€šè¿‡é€’å½’è°ƒç”¨ walk å‡½æ•°æ¥éå†æ•´ä¸ªæ ‘, ä»£ç å¦‚ä¸‹æ‰€ç¤º:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">walk</span><span class=\"token punctuation\">(</span>a1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">walk</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">instance</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">doWork</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> children <span class=\"token operator\">=</span> instance<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>children<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n      children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>walk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">doWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">o</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ä¸Šè¿°ä»£ç ä¼šè¾“å‡º:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">a1, b1, b2, c1, d1, d2, b3, c2</code></pre></div>\n<p>é€’å½’éå¸¸é€‚åˆéå†æ ‘å‹ç»“æ„. ä½†æ˜¯å®ƒæœ‰ä¸€ä¸ªæœ€å¤§çš„å±€é™æ€§, é‚£å°±æ˜¯<strong>ä¸èƒ½å°†æŸä¸ªå·¥ä½œæ‹†åˆ†ä¸ºç²’åº¦æ›´å°çš„å•å…ƒ</strong>ã€‚ æˆ‘ä»¬ä¸èƒ½æš‚åœç»„ä»¶çš„æ›´æ–°å·¥ä½œå¹¶ä¸”åœ¨åç»­çš„æŸä¸ªæ—¶é—´æ®µå†…æ¢å¤å®ƒ. React ä¼šä¸€ç›´é€šè¿‡è¿™ç§æ–¹å¼æ¥éå†, ç›´åˆ°å¤„ç†å®Œæ‰€æœ‰çš„ç»„ä»¶å¹¶ä¸”è°ƒç”¨æ ˆä¸ºç©º(è¿™å¯èƒ½è€—æ—¶è¾ƒé•¿)ã€‚</p>\n<p>è¿™ä¸ªé—®é¢˜çš„æ ¹æºè¿˜åœ¨äºJSXï¼ŒJSXåŒæ—¶æ»¡è¶³äº†<strong>ç»„ä»¶åŒ–ä¸æ ‡ç­¾åŒ–</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n   </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Foo</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Bar</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n   </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Foo</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>ä½†<strong>æ ‡ç­¾åŒ–æ˜¯å¤©ç„¶å¥—åµŒçš„ç»“æ„ï¼Œæ„å‘³ç€å®ƒä¼šæœ€ç»ˆç¼–è¯‘æˆé€’å½’æ‰§è¡Œçš„ä»£ç </strong>ã€‚é€’å½’ä¸å¯é¿å…ä¼šäº§ç”Ÿè°ƒç”¨\"æ ˆ\"çš„å †å ï¼Œä½¿ç”¨æ ˆå¾ˆæ–¹ä¾¿ï¼Œå› ä¸ºä½ æ— éœ€è‡ªå·±è·Ÿè¸ªâ€œç›’å­å †â€ï¼Œæ ˆæ›¿ä½ è¿™æ ·åšäº†,ä½†æ˜¯ä¹Ÿè¦ä»˜å‡ºä»£ä»·ï¼šå­˜å‚¨è¯¦å°½çš„ä¿¡æ¯å¯èƒ½å ç”¨å¤§é‡çš„å†…å­˜ã€‚æ¯ä¸ªå‡½æ•°è°ƒç”¨éƒ½è¦å ç”¨ä¸€å®šçš„å†…å­˜ï¼Œå¦‚æœæ ˆå¾ˆé«˜ï¼Œå°±æ„å‘³ç€è®¡ç®—æœºå­˜å‚¨äº†å¤§é‡å‡½æ•°è°ƒç”¨çš„ä¿¡æ¯ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ æœ‰ä¸¤ç§é€‰æ‹©ï¼š</p>\n<ul>\n<li>é‡æ–°ç¼–å†™ä»£ç ï¼Œè½¬è€Œä½¿ç”¨å¾ªç¯</li>\n<li>ä½¿ç”¨<strong>å°¾é€’å½’</strong></li>\n</ul>\n<p>ç”±äºå°¾é€’å½’è°ƒç”¨çš„ä½¿ç”¨æ¡ä»¶è‹›åˆ»ï¼Œæ‰€ä»¥æ–¹æ¡ˆé€‰æ‹©åªèƒ½æ˜¯è½¬è€Œä½¿ç”¨å¾ªç¯ï¼Œ äº‹å®ä¸Š, React é‡‡ç”¨äº†<strong>å•é“¾è¡¨æ ‘çŠ¶ç»“æ„çš„éå†ç®—æ³•</strong>ã€‚ è¿™ä½¿å¾—å¯ä»¥<strong>æš‚åœéå†å¹¶ä¸”æŠ‘åˆ¶è°ƒç”¨æ ˆçš„å¢é•¿</strong>ã€‚</p>\n<h3>é“¾è¡¨éå†</h3>\n<p>å¹¸è¿çš„æ˜¯, æˆ‘åœ¨ Sebastian MarkbÃ¥ge çš„ <a href=\"https://github.com/facebook/react/issues/7942?source=post_page---------------------------#issue-182373497\">issue</a> å‘ç°äº†å…³äºè¿™ä¸ªç®—æ³•çš„ ä»£ç ç‰‡æ®µ. è¦å®ç°è¿™ä¸ªç®—æ³•, éœ€è¦ä¸€ä¸ªæ•°æ®ç»“æ„, å®ƒæœ‰ä¸‰ä¸ªå­—æ®µ:</p>\n<ul>\n<li>child - æŒ‡å‘ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹</li>\n<li>sibling - æŒ‡å‘ç¬¬ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹</li>\n<li>return - æŒ‡å‘çˆ¶èŠ‚ç‚¹</li>\n</ul>\n<p>åœ¨æ–°çš„ reconciliation ç®—æ³•æ¡ä»¶ä¸‹, ç”± Fiber æ¥è°ƒç”¨ä¸Šè¿°å­—æ®µç»„æˆçš„æ•°æ®ç»“æ„. åœ¨åº•å±‚å®ƒä»£è¡¨ä¸€ä¸ª React Element. æˆ‘çš„ä¸‹ä¸€ç¯‡æ–‡ç« ä¼šè®²è¿°æ›´å¤šçš„æœ‰å…³äºå®ƒçš„çŸ¥è¯†.</p>\n<blockquote>\n<p>æ³¨æ„ï¼Œchildå±æ€§ä»…ä»…æŒ‡å‘â€œé•¿å­â€ï¼Œè€Œæ¬¡å­æ˜¯é€šè¿‡â€œé•¿å­â€çš„siblingå±æ€§æŒ‡å‘çš„ï¼Œä½†æ˜¯ä¸ç®¡é•¿å­è¿˜æ˜¯æ¬¡å­ï¼Œéƒ½åŒ…å«è¿”å›çˆ¶å…ƒç´ çš„return å¼•ç”¨</p>\n</blockquote>\n<p>å¦‚ä¸‹æ‰€ç¤ºçš„æµç¨‹å›¾å±•ç¤ºäº†å„ä¸ªèŠ‚ç‚¹é—´çš„å…³ç³»:</p>\n<p><img src=\"https://p5.music.126.net/obj/wo3DlcOGw6DClTvDisK1/8052715769/9d42/293c/0e06/8a958ee002dba604ed7cd403c0b2521e.png\" alt=\"\"></p>\n<p>å› æ­¤æˆ‘ä»¬é¦–å…ˆå®šä¹‰èŠ‚ç‚¹çš„æ•°æ®ç»“æ„:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Node</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">instance</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>instance <span class=\"token operator\">=</span> instance<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>child <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>sibling <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>return <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>å¦‚ä¸‹æ‰€ç¤º, ä½¿ç”¨ <code class=\"language-text\">link</code> å‡½æ•°å°†ç”± <code class=\"language-text\">render</code> å‡½æ•°è¿”å›çš„å­èŠ‚ç‚¹åˆ—è¡¨è¿ç»“:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">link</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">parent<span class=\"token punctuation\">,</span> elements</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>elements <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> elements <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// å­å…ƒç´ æ•°ç»„å€’å™éå†ï¼Œä¾æ¬¡æ·»åŠ çˆ¶å…ƒç´ (return) å’Œ ä¸‹ä¸€ä¸ªå…„å¼Ÿå…ƒç´ (sibling)</span>\n    <span class=\"token comment\">// è¯·æ³¨æ„æœ€åä¸€ä¸ªå­å…ƒç´ æ˜¯æ²¡æœ‰ sibling çš„</span>\n    parent<span class=\"token punctuation\">.</span>child <span class=\"token operator\">=</span> elements<span class=\"token punctuation\">.</span><span class=\"token function\">reduceRight</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">previous<span class=\"token punctuation\">,</span> current</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> node <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Node</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        node<span class=\"token punctuation\">.</span>return <span class=\"token operator\">=</span> parent<span class=\"token punctuation\">;</span>\n        node<span class=\"token punctuation\">.</span>sibling <span class=\"token operator\">=</span> previous<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> node<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> parent<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>link æ–¹æ³•ä»åå¾€å‰éå†èŠ‚ç‚¹åˆ—è¡¨, å°†å®ƒä»¬ä»¥å•é“¾è¡¨çš„å½¢å¼è¿æ¥. å‡½æ•°æœ€ç»ˆè¿”å›ä¸€ä¸ªæŒ‡é’ˆ, æŒ‡å‘åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹. å¦‚ä¸‹ä»£ç æ‰€ç¤º:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> children <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>name<span class=\"token operator\">:</span> <span class=\"token string\">'b1'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>name<span class=\"token operator\">:</span> <span class=\"token string\">'b2'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> parent <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Node</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>name<span class=\"token operator\">:</span> <span class=\"token string\">'a1'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> child <span class=\"token operator\">=</span> <span class=\"token function\">link</span><span class=\"token punctuation\">(</span>parent<span class=\"token punctuation\">,</span> children<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// the following two statements are true</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">.</span>instance<span class=\"token punctuation\">.</span>name <span class=\"token operator\">===</span> <span class=\"token string\">'b1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">.</span>instance <span class=\"token operator\">===</span> children<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>åŒæ—¶, æˆ‘ä»¬ä¹Ÿå®ç°äº†ä¸€ä¸ª <code class=\"language-text\">doWork</code>è¾…åŠ©å‡½æ•°, æ‰§è¡Œå¯¹å•ä¸ªèŠ‚ç‚¹çš„æ“ä½œ. å‡½æ•°å†…éƒ¨æ‰“å°äº†ç»„ä»¶çš„åç§°(component.name). é™¤æ­¤ä¹‹å¤–, å®ƒæ£€ç´¢äº†å­èŠ‚ç‚¹åˆ—è¡¨, å¹¶ä¸”å°†å­èŠ‚ç‚¹å’Œçˆ¶èŠ‚ç‚¹/å…„å¼ŸèŠ‚ç‚¹è¿ç»“èµ·æ¥, ä»£ç å¦‚ä¸‹æ‰€ç¤º:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">doWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">node</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>instance<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> children <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>instance<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">link</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">,</span> children<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>å¥½çš„, ç°åœ¨æˆ‘ä»¬å®ç°äº†æ ¸å¿ƒçš„éå†ç®—æ³•. é‡‡ç”¨çš„æ˜¯æ·±åº¦ä¼˜å…ˆçš„ç­–ç•¥, ä»£ç å¦‚ä¸‹æ‰€ç¤º:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">walk</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">o</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> root <span class=\"token operator\">=</span> o<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> current <span class=\"token operator\">=</span> o<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// perform work for a node, retrieve &amp; link the children</span>\n        <span class=\"token keyword\">let</span> child <span class=\"token operator\">=</span> <span class=\"token function\">doWork</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// if there's a child, set it as the current active node</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            current <span class=\"token operator\">=</span> child<span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">continue</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// if we've returned to the top, exit the function</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current <span class=\"token operator\">===</span> root<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// keep going up until we find the sibling</span>\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>current<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n            <span class=\"token comment\">// if we've returned to the top, exit the function</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>current<span class=\"token punctuation\">.</span>return <span class=\"token operator\">||</span> current<span class=\"token punctuation\">.</span>return <span class=\"token operator\">===</span> root<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token comment\">// set the parent as the current active node</span>\n            current <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>return<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// if found, set the sibling as the current active node</span>\n        current <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>å°½ç®¡ä¸Šé¢çš„ä»£ç å®ç°ä¸éš¾ç†è§£, ä½ è¿˜æ˜¯è¦è‡ªå·± å°è¯•ä¸€ä¸‹. ä¸Šè¿°ç®—æ³•çš„ç†å¿µæ˜¯ä¿æŒå¯¹ current node(å½“å‰èŠ‚ç‚¹) çš„å¼•ç”¨, å¹¶ä¸”åœ¨éå†æ ‘ä¸­çš„æŸä¸€æ¡è·¯å¾„çš„æ—¶å€™é‡æ–°èµ‹å€¼, ç›´åˆ°éå†åˆ°å°½å¤´. ä¹‹åä½¿ç”¨ return æŒ‡é’ˆè¿”å›çˆ¶çº§èŠ‚ç‚¹ï¼Œè¿™æ˜¯ä¸€ç§çˆ¶çº§ä¼˜å…ˆï¼Œæ·±åº¦ä¼˜å…ˆçš„éå†ç®—æ³•ã€‚</p>\n<p><a href=\"https://gist.github.com/Sylvenas/e8aba3432a5ab2858e93deb1d03c08a6\">è¿™é‡ŒæŸ¥çœ‹å®Œæ•´ä»£ç </a></p>\n<p>å¦‚æœæˆ‘ä»¬æ£€æŸ¥ä¸Šè¿°ç®—æ³•çš„è°ƒç”¨æ ˆ, å°±ä¼šçœ‹åˆ°:</p>\n<p><img src=\"https://d2.music.126.net/dmusic/obj/w5zCg8OAw6HDjzjDgMK_/8052870423/b407/2bb5/00b0/52d7a95267980b8d55385bfbdefd30c2.gif?download=1_ybVgRoNf-dBxR_OKxn4oKQ.gif\" alt=\"\"></p>\n<p>å¯ä»¥çœ‹åˆ°, è°ƒç”¨æ ˆå¹¶æ²¡æœ‰éšç€æ ‘çš„éå†è€Œå¢é•¿. ä½†æ˜¯å¦‚æœç°åœ¨ç»™ doWork æ–¹æ³•æ‰“ä¸ªæ–­ç‚¹, å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ç»“æœ:</p>\n<p><img src=\"https://d2.music.126.net/dmusic/obj/w5zCg8OAw6HDjzjDgMK_/8052902015/2685/fea5/1137/18c4261173d73092d1e44712f912c70a.gif?download=1_ErzqXpJt5KkLKxHCn31hmA.gif\" alt=\"\"></p>\n<p>ç”¨ç»„ä»¶æ ‘çš„ç»“æ„æ¥è¡¨è¾¾ï¼Œéå†çš„é¡ºåºå¦‚ä¸‹ï¼š</p>\n<p><img src=\"https://p6.music.126.net/obj/wo3DlcOGw6DClTvDisK1/8053983966/74a2/530c/746a/312ba32b547c6851d583b3642be0d7c1.png\" alt=\"\"></p>\n<p>è¿™çœ‹èµ·æ¥å¾ˆåƒæµè§ˆå™¨çš„è°ƒç”¨æ ˆ. å› æ­¤é€šè¿‡è¿™ä¸ªç®—æ³•, æˆ‘ä»¬æœ‰æ•ˆåœ°åˆ©ç”¨æˆ‘ä»¬è‡ªå·±å®ç°çš„è°ƒç”¨æ ˆæ›¿ä»£äº†æµè§ˆå™¨é»˜è®¤çš„è°ƒç”¨æ ˆ. Andrew ä¹Ÿæåˆ°äº†è¿™ä¸€ç‚¹:</p>\n<blockquote>\n<p>Fiber æ˜¯è°ƒç”¨æ ˆçš„é‡æ–°å®ç°, ä¸“ä¸º React ç»„ä»¶è®¾è®¡. ä½ å¯ä»¥å°†ä¸€ä¸ª fiber çœ‹ä½œä¸€ä¸ªè™šæ‹Ÿçš„æ ˆå¸§.</p>\n</blockquote>\n<p>å› ä¸ºæˆ‘ä»¬ç°åœ¨é€šè¿‡ä¿æŒå¯¹èŠ‚ç‚¹çš„å¼•ç”¨æ¥ç®¡ç†è°ƒç”¨æ ˆ, æ‰€ä»¥è¯¥èŠ‚ç‚¹å¯ä»¥çœ‹ä½œä¸€ä¸ªé¡¶çº§å¸§:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">walk</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">o</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> root <span class=\"token operator\">=</span> o<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> current <span class=\"token operator\">=</span> o<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token operator\">...</span>\n\n            current <span class=\"token operator\">=</span> child<span class=\"token punctuation\">;</span>\n            <span class=\"token operator\">...</span>\n            \n            current <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>return<span class=\"token punctuation\">;</span>\n            <span class=\"token operator\">...</span>\n\n            current <span class=\"token operator\">=</span> current<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>æˆ‘ä»¬å¯ä»¥åœ¨ä»»ä½•æ—¶å€™ä¸­æ–­æˆ–æ¢å¤éå†. è¿™æ­£æ˜¯ä½¿ç”¨ requestIdleCallback API çš„å‰ç½®æ¡ä»¶.</p>\n<h2>What is Fiber ?</h2>\n<p>Fiber å¯ä»¥ä»ä¸¤ä¸ªè§’åº¦ç†è§£ï¼š</p>\n<h3>ä¸€ç§æµç¨‹æ§åˆ¶åŸè¯­</h3>\n<p>è¿›ç¨‹/çº¿ç¨‹æ˜¯ç»å¸¸é‡åˆ°çš„æ¦‚å¿µï¼Œè¿˜æœ‰ä¸€ä¸ªæ¦‚å¿µâ€œåç¨‹â€,åœ¨<a href=\"https://ruby-doc.org/core-3.0.0/Fiber.html\">Rubyä¸­çš„åç¨‹</a>å°±ç§°ä¸ºâ€œFiberâ€,å…¶å®å¾ˆå¤šè¯­è¨€éƒ½æœ‰ç±»ä¼¼çš„æœºåˆ¶ï¼Œä¾‹å¦‚ Lua çš„Coroutine, è¿˜æœ‰å‰ç«¯å¼€å‘è€…æ¯”è¾ƒç†Ÿæ‚‰çš„ ES6 æ–°å¢çš„ <code class=\"language-text\">Generator</code>ã€‚'åç¨‹'åªæ˜¯ä¸€ç§æ§åˆ¶æµç¨‹çš„è®©å‡ºæœºåˆ¶ã€‚è¦ç†è§£åç¨‹ï¼Œä½ å¾—å’Œæ™®é€šå‡½æ•°ä¸€èµ·æ¥çœ‹, ä»¥Generatorä¸ºä¾‹:</p>\n<p>æ™®é€šå‡½æ•°æ‰§è¡Œçš„è¿‡ç¨‹ä¸­æ— æ³•è¢«ä¸­æ–­å’Œæ¢å¤ï¼š</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> tasks <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> task\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>task <span class=\"token operator\">=</span> tasks<span class=\"token punctuation\">.</span><span class=\"token function\">shift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">execute</span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>è€Œ Generator å¯ä»¥:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> tasks <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">function</span> <span class=\"token operator\">*</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> task\n\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>task <span class=\"token operator\">=</span> tasks<span class=\"token punctuation\">.</span><span class=\"token function\">shift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ğŸ”´ åˆ¤æ–­æ˜¯å¦æœ‰é«˜ä¼˜å…ˆçº§äº‹ä»¶éœ€è¦å¤„ç†, æœ‰çš„è¯è®©å‡ºæ§åˆ¶æƒ</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">hasHighPriorityEvent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">yield</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// å¤„ç†å®Œé«˜ä¼˜å…ˆçº§äº‹ä»¶åï¼Œæ¢å¤å‡½æ•°è°ƒç”¨æ ˆï¼Œç»§ç»­æ‰§è¡Œ...</span>\n    <span class=\"token function\">execute</span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>React Fiber çš„æ€æƒ³å’Œåç¨‹çš„æ¦‚å¿µæ˜¯å¥‘åˆçš„: React render/reconciliationçš„è¿‡ç¨‹å¯ä»¥è¢«ä¸­æ–­ï¼Œå¯ä»¥å°†æ§åˆ¶æƒäº¤å›æµè§ˆå™¨ï¼Œè®©ä½ç»™é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œæµè§ˆå™¨ç©ºé—²åå†æ¢å¤render/reconciliationã€‚</p>\n<h3>ä¸€ç§æ•°æ®ç»“æ„</h3>\n<p>Fiberçš„å¦å¤–ä¸€ç§è§£è¯»æ˜¯'çº¤ç»´': è¿™æ˜¯ä¸€ç§æ•°æ®ç»“æ„æˆ–è€…è¯´æ‰§è¡Œå•å…ƒã€‚Reactè¦å®ç°éå† component tree ä»â€œé€’å½’â€åˆ°â€œå¾ªç¯â€çš„è½¬æ¢ï¼Œå¿…ç„¶éœ€è¦ä¸€ç§ç‰¹æ®Šçš„æ•°æ®ç»“æ„ï¼Œè€Œè¿™ç§ç»“æ„å°±æ˜¯ä¸Šæ–‡ä¸­ä»‹ç»çš„<code class=\"language-text\">Node</code>,æ ¸å¿ƒæ˜¯åŒ…å«<code class=\"language-text\">child</code>,<code class=\"language-text\">return</code>,<code class=\"language-text\">sibling</code>ä¸‰ä¸ªç”¨æ¥è¡¨ç¤ºå…³ç³»çš„ç»“æ„ã€‚</p>\n<blockquote>\n<p>Fiber å®Œæ•´çš„æ•°æ®ç»“æ„å¯ä»¥<a href=\"https://github.com/lit-forest/Blog/issues/1\">æŸ¥çœ‹</a></p>\n</blockquote>\n<h2>æ€»ç»“</h2>\n<p>Fiberæ˜¯ä¸€ç§æ¨¡æ‹Ÿå‡½æ•°è°ƒç”¨æ ˆçš„æ–¹æ¡ˆï¼Œä¸€ç§å¯ä»¥ä¸­æ–­/ç»§ç»­çš„æ–¹æ¡ˆï¼Œè€Œä¸ºäº†å®ç°è¿™ä¸ªæ–¹æ¡ˆï¼Œreactå®šä¹‰äº†ä¸€ç§åŒ…å«<code class=\"language-text\">child</code>,<code class=\"language-text\">return</code>,<code class=\"language-text\">sibling</code>çš„æ•°æ®ç»“æ„,åŒæ—¶fiberä¸­åŒ…å«ç€è™šæ‹Ÿdomçš„æŒ‡é’ˆ(stateNode)ï¼Œæ¥å®Œæˆä»â€œé€’å½’â€åˆ°â€œå¾ªç¯â€çš„æ›¿æ¢ã€‚</p>","excerpt":"åŸæ–‡é“¾æ¥ å‰ç½®çŸ¥è¯† Fiber æ¶æ„æœ‰ä¸¤ä¸ªä¸»è¦çš„æ¸²æŸ“é˜¶æ®µ: reconciliation/render commit åœ¨æºç ä¸­ reconciliation é˜¶æ®µä¹Ÿè¢«è§†ä¸º \"render\" é˜¶æ®µ. åœ¨è¯¥é˜¶æ®µ, React ä¼šéå†æ•´ä¸ªç»„ä»¶æ ‘, å¹¶ä¸”è¿›è¡Œå¦‚ä¸‹æ“ä½œ: æ›´æ–° state å’Œ props è°ƒç”¨ç”Ÿå‘½å‘¨æœŸæ–¹æ³• æ£€ç´¢å½“å‰ç»„ä»¶çš„å­ç»„ä»¶ æ¯”å¯¹æ–°è€å­ç»„ä»¶ è®¡ç®—å‡ºéœ€è¦åœ¨ commit é˜¶æ®µè¢«æ‰§è¡Œçš„ DOM æ›´æ–° ä¸Šè¿°æ‰€æœ‰æ“ä½œè¢«ç§°ä¸º Fiber å†…éƒ¨å·¥ä½œ(work inside Fiberâ€¦","fields":{"slug":"/blog/2019/03/04/react-fiber.html","date":"2019-03-03T16:00:00.000Z"},"frontmatter":{"title":"[è¯‘+æ”¹] React Fiber ä¸­ä¸ºä½•ä»¥åŠå¦‚ä½•ä½¿ç”¨é“¾è¡¨éå†ç»„ä»¶æ ‘","img":"./img/2015-03-25.jpg","author":["Sylvenas"],"categories":"React"}}},"pageContext":{"slug":"/blog/2019/03/04/react-fiber.html"}},"staticQueryHashes":[]}